name: PR Health Check

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    # Allow manual trigger
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-pr-status:
    runs-on: ubuntu-latest
    name: Check PR Status and Conflicts
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Fetch all branches
        run: |
          git fetch --all
          git branch -r
          
      - name: Check for merge conflicts in open PRs
        id: conflict-check
        run: |
          echo "## PR Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get all PR branches
          PR_BRANCHES=$(git branch -r | grep 'origin/copilot/' | grep -v HEAD | sed 's|origin/||' | tr '\n' ' ')
          
          echo "### Open PR Branches" >> $GITHUB_STEP_SUMMARY
          for branch in $PR_BRANCHES; do
            echo "- $branch" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check each branch for conflicts
          echo "### Conflict Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CONFLICTS_FOUND=0
          
          for branch in $PR_BRANCHES; do
            echo "Checking $branch..."
            git checkout "$branch" --quiet || continue
            
            # Try to merge with main
            if git merge-base HEAD origin/main > /dev/null 2>&1; then
              BASE=$(git merge-base HEAD origin/main)
              AHEAD=$(git rev-list --count $BASE..HEAD)
              BEHIND=$(git rev-list --count HEAD..$BASE)
              
              echo "#### \`$branch\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Commits ahead**: $AHEAD" >> $GITHUB_STEP_SUMMARY
              echo "- **Commits behind**: $BEHIND" >> $GITHUB_STEP_SUMMARY
              
              # Check for conflicts
              if git merge origin/main --no-commit --no-ff --quiet 2>/dev/null; then
                echo "- **Status**: ✅ No conflicts" >> $GITHUB_STEP_SUMMARY
                git merge --abort 2>/dev/null || true
              else
                echo "- **Status**: ❌ Has merge conflicts" >> $GITHUB_STEP_SUMMARY
                CONFLICTS_FOUND=1
                
                # List conflicting files
                git merge origin/main --no-commit --no-ff 2>&1 | grep "CONFLICT" | while read -r line; do
                  echo "  - $line" >> $GITHUB_STEP_SUMMARY
                done
                git merge --abort 2>/dev/null || true
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          # Return to original branch
          git checkout "${GITHUB_HEAD_REF:-main}" --quiet || git checkout main --quiet
          
          if [ $CONFLICTS_FOUND -eq 1 ]; then
            echo "conflicts_found=true" >> $GITHUB_OUTPUT
          else
            echo "conflicts_found=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Comment on PR if conflicts detected
        if: github.event_name == 'pull_request' && steps.conflict-check.outputs.conflicts_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Merge Conflict Detected**\n\nThis PR has conflicts with the `main` branch. Please resolve them before merging.\n\nSee the [PR Management Guide](../blob/main/PR_MANAGEMENT.md) for help resolving conflicts.'
            })
            
      - name: Create issue if conflicts persist
        if: steps.conflict-check.outputs.conflicts_found == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'merge-conflict'
            });
            
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '⚠️ Merge Conflicts Detected in Open PRs',
                body: 'Automated PR health check detected merge conflicts in one or more open pull requests.\n\nPlease review the [PR Management Guide](PR_MANAGEMENT.md) and resolve conflicts.\n\nRun the check script locally:\n```bash\nbash .github/scripts/check-pr-status.sh\n```',
                labels: ['merge-conflict', 'automated']
              });
            }
